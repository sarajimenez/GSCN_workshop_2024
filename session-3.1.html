
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction 3 &#8212; GSCN workshop 2024</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'session-3.1';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">GSCN workshop 2024</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Single-cell analysis template repository
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Session 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="session-1.html">Introduction</a></li>








</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/sarajimenez/GSCN_workshop_2024" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/session-3.1.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction 3</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction 3</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-processed-data">Load processed data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#trajectory-inference">Trajectory Inference</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diffusion-maps">Diffusion Maps</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-1-scanpy-inbuilt-diffusion-maps">Method 1: Scanpy inbuilt diffusion maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-data-2-cells-along-a-continuum">Example data 2: Cells along a continuum</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nearest-neighbor-and-diffusion-maps">Nearest neighbor and diffusion maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-2-using-code-for-magic-to-do-diffusion-maps">Method 2: Using code for MAGIC to do diffusion maps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#palantir">Palantir</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-start-cell">Define start cell</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-terminal-states">Define terminal states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-pseudotime">Compute pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-pseudotime">Get the pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-pseudotime">Visualize the pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-probability-for-cells-to-reach-certain-terminal-state">Visualize the probability for cells to reach certain terminal state</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-gene-expression-trends">Visualize gene expression trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-gene-expression-trends">Clustering gene expression trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#paga">PAGA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#paga-with-distances-computed-on-pca">PAGA with distances computed on PCA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#paga-on-diffusion-components">PAGA on diffusion components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-results-to-quantify-distance-between-clusters">Using results to quantify distance between clusters</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-3">
<h1>Introduction 3<a class="headerlink" href="#introduction-3" title="Link to this heading">#</a></h1>
<p>In this notebook, we will explore the problem of trajectory analysis</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="load-packages">
<h1>Load packages<a class="headerlink" href="#load-packages" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="load-processed-data">
<h1>Load processed data<a class="headerlink" href="#load-processed-data" title="Link to this heading">#</a></h1>
<p>We will continue with the data used in session-1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/sharmar1/Dropbox/msk_workshop/materials_2023_2024_batch1/session-1/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_clean</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">input_path</span> <span class="o">+</span> <span class="s1">&#39;processed_adata.h5ad&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 11769 × 13730
    obs: &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;mt_pct_content&#39;, &#39;total_counts_ribo&#39;, &#39;pct_counts_ribo&#39;, &#39;ribo_pct_content&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;mt&#39;, &#39;n_cells&#39;, &#39;ribo&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="trajectory-inference">
<h1>Trajectory Inference<a class="headerlink" href="#trajectory-inference" title="Link to this heading">#</a></h1>
<p>scRNA-seq has been applied extensively to study developmental systems. It is now generally understood that the process of differentiation is a continuous process rather than a series of discreet/distinct stages. Trajectory inference is a computational framework to align the cells developing from one phenotype to another along a continuous axis (also called pseudotime).</p>
<p>Underlying pseudotime analysis is the assumption that because differentiation process is asynchronous, a single snapshot of scRNA-seq data comprises of cells in all possible states during the process. This allows us to utilize the heterogeneity among the cells to align them along a continuous axis. In essence, we are interested in capturing gradual changes during the process, which means we ought to understand and map local similarity between cells. As we have discussed extensively in sessions 2 and 3, graphs are the perfect mathematical tools to do so. Therefore, all the methods we discuss below will rely on modeling the data using a graph.</p>
<p>There are tens of algorithms developed to perform pseudotime analysis on single-cell RNA-seq data. Here, we will discuss two important methods, namely diffusion maps and Palantir, for their effectiveness and success we have seen in scRNA-seq data analysis. ( Note: Palantir develops on top of diffusion maps).</p>
<p>Refs:</p>
<p><a class="reference external" href="https://www.nature.com/articles/s41587-019-0071-9?platform=hootsuite">https://www.nature.com/articles/s41587-019-0071-9?platform=hootsuite</a></p>
<p><a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/30899105/">https://pubmed.ncbi.nlm.nih.gov/30899105/</a></p>
<p><a class="reference external" href="https://www.nature.com/articles/nmeth.3971">https://www.nature.com/articles/nmeth.3971</a></p>
<section id="diffusion-maps">
<h2>Diffusion Maps<a class="headerlink" href="#diffusion-maps" title="Link to this heading">#</a></h2>
<p>Diffusion Maps are a suite of graph-based techniques to perform non-linear dimensionality reduction of high-dimensional data. They can be crudely thought of as non-linear version of PCA: just like PCA, diffusion maps will identify axis of high variances in the data, but unlike PCA - which is linear - diffusion maps take into consideration  non-linear associations between features (genes in our case) of the data. In other words, diffusion maps transform any high-dimensional data into a lower dimensional Euclidean space by accounting for any non-linear dependencies between the features. In doing so, it preserves the relationship between points that are similar in high-dimensional space and discards distant relationships.</p>
<p>This property of diffusion maps makes it very favorable for single-cell data analysis. By preserving the local neighborhood structure, it provides a platform to incrementally navigate along the data manifold. Unlike diffusion maps, UMAP (and Force Directed Layout) - while useful to visualize data - does not accurately preserve high-dimensional pairwise distances in the resulting low-dimensional representation. This limits the use of UMAP (and Force Directed Layout) to visualization and does not facilitate any further quantitative analysis. However, since diffusion maps are distance preserving, they can be used for downstream analysis.</p>
<p>The need for using diffusion maps also stems from our assumption that scRNA-seq data are inherently noisy and biological signals are masked by the noise. As such, we typically begin by performing principal component analysis as a way to decouple strong variability in the data (true biological signal) from random noise. As we discussed in our previous workshop, this is achieved by retrieving only the top <code class="docutils literal notranslate"><span class="pre">p</span></code> principal components and neglecting the rest (which typically identify with noise in the data) for any downstream analysis. However, we have observed with scRNA-seq data that PCA is generally ideal for working with global aspects of the data (such as to cluster the cells on, visualize the data etc.) but is not <em>always</em> optimal for a finer analysis such as pseudotime alignment of individual cells.</p>
<p>One of the popular ways to study cells along a continuum of gene expression space (as opposed to distinct clusters) is to apply diffusion maps on the retrieved principal components. Because the resulting embedding aims to preserve the local neighborhood of each cell, the diffusion maps form a natural coordinate system for cells along a continuum. As a result, they have been most successfully employed to align cells undergoing development along a trajectory. The success of diffusion maps relies on its ability to capture the geometry of the data accurately.</p>
<p>Diffusion maps work by first building a k-nearest neighbor graph on the principal components (similar to clustering analysis, see session 1 or previous workshop material), followed by conversion of the distance graph to an affinity graph. While there are various models/methods proposed to convert distance matrix to affinity matrix, we recommend using adaptive Gaussian kernel. The kernel ensures that affinity between cells decrease exponentially with distance between cells in every direction (of expression or PCA space) but remains sensitive to density of cells near every cell. In other words, if the neighborhood of a cell is densely sampled then the similarity between cells is more concentrated while if the neighborhood of a cell is sparsely sampled then the similarity is more diffuse. This is important to avoid bias in analysis due to sampling differences in a heterogeneous population of cells. The affinity matrix is then converted into a Markov matrix, which represents a probabilistic framework of cellular state neighborhood. To elaborate, for a data of K cells, the Markov matrix is of size K-by-K; each row of the matrix sums to 1 and the (i, j)-th entry of the matrix represents the probability of a cell transitioning from state i to state j in one time step. Therefore, the Markov matrix automatically provides a probabilistic representation of cellular transition and is well-suited for pseudotime analysis that aims to align the cells along their differentiation transition states. Furthermore, because we begin with the k-nearest neighbor graph, only the immediate neighborhood each cell (i.e. phenotypically most similar cells) get high probability score of transition. Once the Markov matrix is constructed, we obtain the eigenvalues and eigenvectors of the matrix (analogous to the procedure in PCA) and order the eigenvectors based on the associated eigenvalue. We interpret the top eigenvector (we ignore the first eigenvector with eigenvalue of 1, see references below for this) as the direction of highest variability in the data, and often can be used to study cellular transitions in the data. These eigenvectors are called the diffusion components or diffusion maps (maps because they map the data from high-dimensional gene expression or PCA space to a lower dimensional diffusion space). Similarly, we encourage you to explore the next few eigenvectors to study any potential axes of continuum in the data. We will discuss more below.</p>
<p>You will notice that this is very similar to how we performed MAGIC above, and indeed the construction of Markov Matrix is identical and it is used for two separate scenarios.</p>
<p>Refs:
<a class="reference external" href="https://www.nature.com/articles/nmeth.3971">https://www.nature.com/articles/nmeth.3971</a></p>
<p><a class="reference external" href="https://www.nature.com/articles/nbt.3569">https://www.nature.com/articles/nbt.3569</a></p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1063520306000546">https://www.sciencedirect.com/science/article/pii/S1063520306000546</a></p>
<p>The size of the nearest neighborhood (<code class="docutils literal notranslate"><span class="pre">k</span></code> or <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> parameter) is a crucial parameter and analogous to clustering analysis, we recommend you to choose it such that it is small enough to only consider local neighbors of each cell, but large enough that you do not get discrete sub-graphs. A typical choice of <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> is <code class="docutils literal notranslate"><span class="pre">30</span></code>. Furthermore, analogous to clustering analysis, it is highly recommended that you show your results do not vary with slight alterations in the value of <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code>. For example, if you wish to choose <code class="docutils literal notranslate"><span class="pre">n_neighbors</span> <span class="pre">=</span> <span class="pre">30</span></code> then we recommend that you recompute the graph for various values of <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> around <code class="docutils literal notranslate"><span class="pre">30</span></code> such as <code class="docutils literal notranslate"><span class="pre">n_neighbors</span> <span class="pre">=</span> <span class="pre">(21,</span> <span class="pre">24,</span> <span class="pre">27,</span> <span class="pre">30,</span> <span class="pre">33,</span> <span class="pre">36,</span> <span class="pre">39)</span></code> and show that the meaningful diffusion components you obtain for all these values of <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> are highly correlated to each other.</p>
<section id="method-1-scanpy-inbuilt-diffusion-maps">
<h3>Method 1: Scanpy inbuilt diffusion maps<a class="headerlink" href="#method-1-scanpy-inbuilt-diffusion-maps" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 11827 × 17698
    obs: &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;mt_pct_content&#39;, &#39;ribo_pct_content&#39;, &#39;G2_M_checkpoint&#39;, &#39;leiden&#39;, &#39;pheno_leiden&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;, &#39;highly_variable&#39;, &#39;highly_variable_rank&#39;, &#39;means&#39;, &#39;variances&#39;, &#39;variances_norm&#39;
    uns: &#39;draw_graph&#39;, &#39;hvg&#39;, &#39;leiden&#39;, &#39;leiden_colors&#39;, &#39;log1p&#39;, &#39;neighbors_30&#39;, &#39;pca&#39;, &#39;pheno_jaccard_q&#39;, &#39;pheno_leiden_colors&#39;, &#39;umap&#39;
    obsm: &#39;X_draw_graph_fa&#39;, &#39;X_pca&#39;, &#39;X_umap&#39;
    varm: &#39;PCs&#39;
    layers: &#39;raw_data&#39;
    obsp: &#39;neighbors_30_connectivities&#39;, &#39;neighbors_30_distances&#39;, &#39;pheno_jaccard_ig&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># n_comps is the number of top eigenvalues/eigenvectors you would like to compute, 20-30 is usually sufficient</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">diffmap</span><span class="p">(</span><span class="n">adata_clean</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 11827 × 17698
    obs: &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;mt_pct_content&#39;, &#39;ribo_pct_content&#39;, &#39;G2_M_checkpoint&#39;, &#39;leiden&#39;, &#39;pheno_leiden&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;, &#39;highly_variable&#39;, &#39;highly_variable_rank&#39;, &#39;means&#39;, &#39;variances&#39;, &#39;variances_norm&#39;
    uns: &#39;draw_graph&#39;, &#39;hvg&#39;, &#39;leiden&#39;, &#39;leiden_colors&#39;, &#39;log1p&#39;, &#39;neighbors_30&#39;, &#39;pca&#39;, &#39;pheno_jaccard_q&#39;, &#39;pheno_leiden_colors&#39;, &#39;umap&#39;, &#39;diffmap_evals&#39;
    obsm: &#39;X_draw_graph_fa&#39;, &#39;X_pca&#39;, &#39;X_umap&#39;, &#39;X_diffmap&#39;
    varm: &#39;PCs&#39;
    layers: &#39;raw_data&#39;
    obsp: &#39;neighbors_30_connectivities&#39;, &#39;neighbors_30_distances&#39;, &#39;pheno_jaccard_ig&#39;
</pre></div>
</div>
</div>
</div>
<p>We can view the eigenvalues as below. The first eigenvalue is exactly 1 and this expected due to a property of any Markov matrix (any matrix whose rows sum to 1). This only reflects that there is one big connected component in the data (which is a common property across any data by construction and not specific to the current data) and we ignore this eigenvalue and the corresponding eigenvector. Note: if you see multiple eigenvalues exactly equal to 1, which is rare in scRNA-seq data specifically in the context of development, then that has a different, and important, interpretation. Please see the references above.</p>
<p>We interpret the next eigenvalue and the associated eigenvector as the most informative component about the data that indicates direction of most biological variability. Often this indicates towards a possible transition between cell states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span><span class="n">scanpy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata_clean</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])),</span> <span class="n">adata_clean</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Eigen-Values&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Eigen-Values&#39;)
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/b191f6e12a863550e0643da2ae5998f817de5dc913471a0d200ddc0351a61e0c.png"><img alt="_images/b191f6e12a863550e0643da2ae5998f817de5dc913471a0d200ddc0351a61e0c.png" src="_images/b191f6e12a863550e0643da2ae5998f817de5dc913471a0d200ddc0351a61e0c.png" style="width: 576px; height: 422px;" /></a>
</div>
</div>
<p>We also use the first large gap in the eigenvalue spectrum (i.e. the plot above) to quantify the number of most meaningful diffusion components to consider for analysis. For example, in the plot above, we see a substantial gap between 6th and 7th eigenvalue. This indicates that perhaps the first 6 eigenvalues and associated eigenvectors are the most meaningful. This may seem a bit arbitrary (especially when you see that there is a much bigger change between 17th and 18th eigenvector), and we will discuss how to avoid this pitfall in the next session (see Palantir).</p>
<p>We visualize the top 10 eigenvectors as follows (Note: we must ignore the first i.e. 0th eigenvector from downstream analysis):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_clean</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_umap&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_clean</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_umap&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">c</span> <span class="o">=</span> <span class="n">adata_clean</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diff Map - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    
<span class="c1"># To save: </span>
<span class="c1"># fig.savefig(output_directory + &#39;umap_colored_by_diff_maps.png&#39;, bbox_inches = &#39;tight&#39;, dpi = 150)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="_images/27ce52a58c2a0f764521c66ab92b13e299ec60193045c54dbb5700bfce153667.png"><img alt="_images/27ce52a58c2a0f764521c66ab92b13e299ec60193045c54dbb5700bfce153667.png" src="_images/27ce52a58c2a0f764521c66ab92b13e299ec60193045c54dbb5700bfce153667.png" style="width: 2019px; height: 1132px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata_clean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;pheno_leiden&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/sharmar1/miniconda3/envs/workshop_2024/lib/python3.8/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/eefac8ca815f464e0164b3022128b143ab4dee4588e99c928163a3df9bdf70a9.png"><img alt="_images/eefac8ca815f464e0164b3022128b143ab4dee4588e99c928163a3df9bdf70a9.png" src="_images/eefac8ca815f464e0164b3022128b143ab4dee4588e99c928163a3df9bdf70a9.png" style="width: 634px; height: 417px;" /></a>
</div>
</div>
<p>Interpreting the diffusion maps:</p>
<ol class="arabic simple">
<li><p>We ignore the 0th diffusion component (for reasons, please see the text above and the provided references).</p></li>
<li><p>The next top diffusion component (Diff Map - 1) separates out the myeloid compartment, which indicates that the biggest variance in the data is across the various cell lines (which makes sense) - particularly between Myeloid &amp; T+B cells.</p></li>
<li><p>Diff Map - 2 separates out the B cells (clusters 6+7+17).</p></li>
<li><p>Diff Map - 3 identifies the small cluster 9 as being distinct from rest of the data. Note: if C9 is so different and is not clear what kind of cell type it is, diffusion maps could be hinting that it is a rare and distinct or a noisy cluster of cells. As such, diffusion maps can be used for data clean-up as well.</p></li>
</ol>
<p>And so forth.</p>
<p>To summarize, diffusion maps attempt to highlight the differences or variablity in the data. However, we set out to illustrate the use of diffusion maps for the context of aligning cells on a continuous axis and as such, applying it to data with clear separated clusters (like the example above) is not ideal. Therefore, we will run diffusion maps on a separate data (provided along with this notebook) and interpret the findings.</p>
</section>
<section id="example-data-2-cells-along-a-continuum">
<h3>Example data 2: Cells along a continuum<a class="headerlink" href="#example-data-2-cells-along-a-continuum" title="Link to this heading">#</a></h3>
<p>The data is taken from <a class="reference external" href="https://www.nature.com/articles/s41587-019-0068-4">https://www.nature.com/articles/s41587-019-0068-4</a> and downloaded from <a class="github reference external" href="https://github.com/dpeerlab/Palantir">dpeerlab/Palantir</a>. The data has already been normalized, clustered, cell type annotated and visualization maps have also been computed.</p>
<p>The data consists of CD34+ human bone marrow cells undergoing differentiation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;/data/peer/sharmar1/msk_workshop/workshop_2024_spring/session-2/human_cd34_bm_rep1_sub.h5ad&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;
    obsm: &#39;tsne&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change the name of the obsm so we can invoke scanpy plotting functions</span>
<span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;clusters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/sharmar1/miniconda3/envs/workshop_2024/lib/python3.8/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div>
</div>
<img alt="_images/2cbd42d3fb1915d43b1d789f717ba80bc9d6a1680180c711f882fa2821162d6c.png" src="_images/2cbd42d3fb1915d43b1d789f717ba80bc9d6a1680180c711f882fa2821162d6c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize some gene expression trends</span>
<span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD34&#39;</span><span class="p">,</span> <span class="s1">&#39;MPO&#39;</span><span class="p">,</span> <span class="s1">&#39;IRF8&#39;</span><span class="p">,</span> <span class="s1">&#39;CD79A&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">,</span> <span class="s1">&#39;ITGA2B&#39;</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="s1">&#39;p99&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c358c98249009cb20556db25859e2bad246ea8df64e302540f2164e189addf99.png" src="_images/c358c98249009cb20556db25859e2bad246ea8df64e302540f2164e189addf99.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We are computing 300 principal components as that is what the authors used. </span>
<span class="c1"># The rationale was that they wanted to consider enough PCs to explain 75% of the variance in the data</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_comps</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;
    varm: &#39;PCs&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="nearest-neighbor-and-diffusion-maps">
<h3>Nearest neighbor and diffusion maps<a class="headerlink" href="#nearest-neighbor-and-diffusion-maps" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute diffusion maps</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="s1">&#39;X_pca&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">diffmap</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Eigenvalues</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])),</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Eigen-Values&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Eigen-Values&#39;)
</pre></div>
</div>
<img alt="_images/4367ed362055666ec8ddeb8497906bc3769604b2a6d3f15e503d580466dbd09b.png" src="_images/4367ed362055666ec8ddeb8497906bc3769604b2a6d3f15e503d580466dbd09b.png" />
</div>
</div>
<p>We see a clear gap between 8th and 9th eigenvalues (note: counting starts at 0). This is indicative that the first 8 eigenvalues are the most informative about the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the first 12 eigenvectors</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">c</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diff Map - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    
<span class="c1"># To save: </span>
<span class="c1"># fig.savefig(output_directory + &#39;umap_colored_by_diff_maps.png&#39;, bbox_inches = &#39;tight&#39;, dpi = 150)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3d7e7c30082eec2eab8c11b6fa53b8ff28075a9192e9aa70e7b35daaf5b38a25.png" src="_images/3d7e7c30082eec2eab8c11b6fa53b8ff28075a9192e9aa70e7b35daaf5b38a25.png" />
</div>
</div>
<p>Interpreting the plots above:</p>
<ol class="arabic simple">
<li><p>We ignore Diff Map - 0 as we have discussed previously.</p></li>
<li><p>Diff Map - 1 tracks the progression of GATA1+ cells (Erythroid cells)</p></li>
<li><p>Diff Map - 2 tracks the progression of CD79A+ cells (Common Lymphoid Progrenitor cells)</p></li>
<li><p>Diff Map - 3 tracks the progression of IRF8+ and MPO+ cells (Dendritic cells and Monocytes)</p></li>
<li><p>Diff Map - 4 trakcs the progression of IRF8+ cells and distinguishes it from MPO+ cells (contrast with Diff Map -3)</p></li>
</ol>
<p>and so forth.</p>
<p>As we can see, diffusion maps clearly track the major changes along the data. The above is a complex example of multiple trajectories or transitions but is a good example case that illustrates the power of diffusion maps in delineating such trajectories.</p>
<p>To perform downstream analysis or interpreting the diffusion components, you can start to identify genes that are correlated (positively or negatively) with the diffusion component that you are interested in investigating. For example, we will correlate the top 10 diffusion components above with every gene and sort them based on their correlation score. First, we will provide code to correlate one diffusion component. Second, we will write a for loop to iterate it over all diffusion components of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlate with diffusion component 1 (Recall: Diff Comp 0 is to be ignored)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">X</span>
<span class="n">diff_1</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">corr_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">corr_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">diff_1</span><span class="p">)</span>
    <span class="n">corr_score</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Arrange that in pandas data frame with associated gene names:</span>
<span class="n">df_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;corr_score&#39;</span><span class="p">:</span> <span class="n">corr_score</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">df_corr</span><span class="p">[</span><span class="s1">&#39;absolute_corr_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_corr</span><span class="p">[</span><span class="s1">&#39;corr_score&#39;</span><span class="p">])</span>
<span class="n">df_corr</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>corr_score</th>
      <th>absolute_corr_score</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A1BG</th>
      <td>-0.167809</td>
      <td>0.167809</td>
    </tr>
    <tr>
      <th>A2M</th>
      <td>-0.003054</td>
      <td>0.003054</td>
    </tr>
    <tr>
      <th>A2ML1</th>
      <td>0.044146</td>
      <td>0.044146</td>
    </tr>
    <tr>
      <th>A4GALT</th>
      <td>0.327103</td>
      <td>0.327103</td>
    </tr>
    <tr>
      <th>AAAS</th>
      <td>0.156136</td>
      <td>0.156136</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sort by absolute value of corr_score (to isolate top positively &amp; negatively correlated genes)</span>
<span class="n">df_corr</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;absolute_corr_score&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>corr_score</th>
      <th>absolute_corr_score</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>KLF1</th>
      <td>0.823961</td>
      <td>0.823961</td>
    </tr>
    <tr>
      <th>APOC1</th>
      <td>0.793427</td>
      <td>0.793427</td>
    </tr>
    <tr>
      <th>CNRIP1</th>
      <td>0.778444</td>
      <td>0.778444</td>
    </tr>
    <tr>
      <th>GATA1</th>
      <td>0.762813</td>
      <td>0.762813</td>
    </tr>
    <tr>
      <th>ANK1</th>
      <td>0.748066</td>
      <td>0.748066</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>TMED6</th>
      <td>-0.000033</td>
      <td>0.000033</td>
    </tr>
    <tr>
      <th>KPTN</th>
      <td>0.000027</td>
      <td>0.000027</td>
    </tr>
    <tr>
      <th>GIPC3</th>
      <td>-0.000024</td>
      <td>0.000024</td>
    </tr>
    <tr>
      <th>KCNJ16</th>
      <td>-0.000019</td>
      <td>0.000019</td>
    </tr>
    <tr>
      <th>RP11-299H22.1</th>
      <td>-0.000008</td>
      <td>0.000008</td>
    </tr>
  </tbody>
</table>
<p>14612 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the trend of top 5 genes along diffusion component 1:</span>
<span class="n">top_genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KLF1&#39;</span><span class="p">,</span> <span class="s1">&#39;APOC1&#39;</span><span class="p">,</span> <span class="s1">&#39;CNRIP1&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">,</span> <span class="s1">&#39;ANK1&#39;</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_genes</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> 
               <span class="n">adata_bm</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">gene</span><span class="p">)],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Diffusion component-1&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8ffd9ef29acd2bb3dedc908da532eee44d5a4b7b362eb5eb94f3854e5342bf38.png" src="_images/8ffd9ef29acd2bb3dedc908da532eee44d5a4b7b362eb5eb94f3854e5342bf38.png" />
</div>
</div>
<p>As we can see, KLF1, GATA1 are some of the highly correlated genes with diffusion component 1. Inspecting the top genes this way can help you get a sense of what each diffusion component is trying to explain.</p>
<p>We can now automate this for all the diffusion components of interest:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlate with top 10 diffusion components</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">X</span>

<span class="k">for</span> <span class="n">diff_comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">diff_comp</span><span class="p">)</span>
    <span class="n">diff_temp</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="n">diff_comp</span><span class="p">]</span>
    <span class="n">corr_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">corr_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">diff_temp</span><span class="p">)</span>
        <span class="n">corr_score</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">df_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;corr_score&#39;</span><span class="p">:</span> <span class="n">corr_score</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df_corr</span><span class="p">[</span><span class="s1">&#39;absolute_corr_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_corr</span><span class="p">[</span><span class="s1">&#39;corr_score&#39;</span><span class="p">])</span>
    
    <span class="c1"># save as csv:</span>
    <span class="c1">#df_corr.to_csv(output_directory + &#39;gene_correlation_with_diffusion_comp_&#39; + str(diff_comp) + &#39;.csv&#39;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
2
3
4
5
6
7
8
9
10
</pre></div>
</div>
</div>
</div>
</section>
<section id="method-2-using-code-for-magic-to-do-diffusion-maps">
<h3>Method 2: Using code for MAGIC to do diffusion maps<a class="headerlink" href="#method-2-using-code-for-magic-to-do-diffusion-maps" title="Link to this heading">#</a></h3>
<p>Diffusion maps are by definition, eigenvectors of the transition matrix we constructed for MAGIC above. Therefore, we can simply re-use that function to get diffusion maps. The only difference between this and Scanpy’s implementation is in the construction of affinity matrix and the final diffusion maps should be largely the same between both the approaches. Both approaches implement an adaptive kernel that takes into account the density of each cell’s neighborhood but do so slightly differently.</p>
<p>The following code is utilized in the code for Palantir (discussed in next session) and MAGIC (discussed above).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/data/peer/sharmar1/msk_workshop/workshop_2024_spring/python_funs/&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">workshop_extra</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14651
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_diff_potential&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;palantir_branch_probs_cell_types&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;diffmap_evals&#39;
    obsm: &#39;tsne&#39;, &#39;MAGIC_imputed_data&#39;, &#39;palantir_branch_probs&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;X_diffmap&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workshop_extra</span><span class="o">.</span><span class="n">run_MAGIC</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
                         <span class="n">t</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                         <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;neighbors_30&#39;</span><span class="p">,</span> 
                         <span class="n">n_components</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                         <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> 
                         <span class="n">key_added</span> <span class="o">=</span> <span class="s1">&#39;magic&#39;</span><span class="p">,</span> 
                         <span class="n">impute</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using pre-computed nearest neighbor graph
Found pre-computed distance matrix with parameters: knn = 30
Using knn_affinity = 10
Creating Kernel
Creating Markov Matrix
Imputing
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/sharmar1/miniconda3/envs/workshop_2024/lib/python3.8/site-packages/scipy/sparse/_index.py:146: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;diffmap_evals&#39;, &#39;magic_diffmap_results&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;X_diffmap&#39;
    varm: &#39;PCs&#39;
    layers: &#39;magic_imputed_data&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<p>The diffusion map related eigenvalues are eigenvectors are stored in <code class="docutils literal notranslate"><span class="pre">.uns['magic_diffmap_results']</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenVectors&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.013153341 ,  0.0237777907,  0.0047869206, ..., -0.0004480488,
        -0.0100692988, -0.0212847453],
       [ 0.013153341 , -0.00646131  ,  0.0001690303, ...,  0.0030085876,
        -0.0004396853, -0.0041244505],
       [ 0.013153341 , -0.0068245753, -0.01016653  , ..., -0.0019847681,
         0.0034083404, -0.0058662161],
       ...,
       [ 0.013153341 ,  0.0020385541, -0.0053041859, ..., -0.0058472668,
         0.006153044 ,  0.0015270734],
       [ 0.013153341 ,  0.0352173622,  0.0096712521, ..., -0.0113952741,
        -0.0130824239,  0.0196389761],
       [ 0.013153341 , -0.003692295 , -0.0064772853, ...,  0.0160565975,
        -0.0080907992,  0.0104769154]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenValues&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.          , 0.9843431886, 0.97387105  , 0.9388438674,
       0.9191380812, 0.9097907768, 0.8892061695, 0.88445972  ,
       0.8248699101, 0.788975555 , 0.7610081635, 0.7524141846,
       0.7129453087, 0.7075921889, 0.6739963072, 0.6640336808,
       0.6529500168, 0.6331083759, 0.6295141749, 0.6177989953,
       0.6025556662, 0.5926315382, 0.5751433947, 0.5667362251,
       0.5497300993, 0.5424339037, 0.5257969499, 0.5197716014,
       0.5135675268, 0.5085867134])
</pre></div>
</div>
</div>
</div>
<p>Visualize top eigenvalues:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Eigenvalues</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenValues&#39;</span><span class="p">])),</span> 
            <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenValues&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Eigen-Values&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Eigen-Values&#39;)
</pre></div>
</div>
<img alt="_images/642368f2f0211f0cdf5001a8bdbe36e01e04bb61e7b1f3e4204ef6be66df3b1b.png" src="_images/642368f2f0211f0cdf5001a8bdbe36e01e04bb61e7b1f3e4204ef6be66df3b1b.png" />
</div>
</div>
<p>Color tSNE by top 10 diffusion maps (recall: We need to ignore the first or the 0th eigenvector):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the first 12 eigenvectors</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">c</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenVectors&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diff Map - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    
<span class="c1"># To save: </span>
<span class="c1"># fig.savefig(output_directory + &#39;umap_colored_by_diff_maps.png&#39;, bbox_inches = &#39;tight&#39;, dpi = 150)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0c844084a96173d9ed9f2dc39fc8e1d5cf595e1e96238c6d7530d1dfe601c817.png" src="_images/0c844084a96173d9ed9f2dc39fc8e1d5cf595e1e96238c6d7530d1dfe601c817.png" />
</div>
</div>
<p>In addition to the diffusion maps, we also computed MAGIC imputed data. So, we can visualize the relationship between imputed gene expression and diffusion components (the 1st diffusion component in this case that tracks along with the Erythroid lineage like we saw above):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the trend of top 5 genes along diffusion component 1:</span>
<span class="n">top_genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KLF1&#39;</span><span class="p">,</span> <span class="s1">&#39;APOC1&#39;</span><span class="p">,</span> <span class="s1">&#39;CNRIP1&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">,</span> <span class="s1">&#39;ANK1&#39;</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_genes</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> 
               <span class="n">adata_bm</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">gene</span><span class="p">)],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Diffusion component-1&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    

<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_genes</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;magic_diffmap_results&#39;</span><span class="p">][</span><span class="s1">&#39;EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> 
               <span class="n">adata_bm</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;magic_imputed_data&#39;</span><span class="p">][:,</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">gene</span><span class="p">)],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Diffusion component-1&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39;, imputed&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a02860324cd66e00272ebd249d645319456252dc82c47543ff200a3e7658e87e.png" src="_images/a02860324cd66e00272ebd249d645319456252dc82c47543ff200a3e7658e87e.png" />
</div>
</div>
</section>
</section>
<section id="palantir">
<h2>Palantir<a class="headerlink" href="#palantir" title="Link to this heading">#</a></h2>
<p>Palantir is a graph-based method to align differentiating cells onto a pseudotime axis. Palantir models the differentiation landscape as a continuum (as opposed to a set of discrete stages) and aligns cells along an axis, automatically identifies and characterizes the terminal differentiated states, and assigns each cell a probablity of differentiating into one of the terminal states.</p>
<p>The key inputs to the method are:</p>
<ol class="arabic simple">
<li><p>scRNA-seq data from a differentiating system</p></li>
<li><p>Start cell, i.e. where the differentiation starts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">k</span></code> or <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> for graph construction.</p></li>
</ol>
<p>We again recommend that you investigate and ensure that your pseudotime and branch probability results are robust to slight variations around input 2 and 3. You can consult Supplementary Figures 5-8 in the reference below:</p>
<p>Ref: <a class="reference external" href="https://www.nature.com/articles/s41587-019-0068-4">https://www.nature.com/articles/s41587-019-0068-4</a></p>
<p>While palantir is integrated into scanpy as <code class="docutils literal notranslate"><span class="pre">sc.external.tl.palantir</span></code>, we suggest you import palantir by itself. The authors have made modifications for easier downstream analysis, which may not be up to date in Scanpy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;
    varm: &#39;PCs&#39;
</pre></div>
</div>
</div>
</div>
<p>As part of the analysis, palantir first computes diffusion maps on the data, then scales the diffusion components based on their eigenvalues (please see the manuscript for more details). Then it uses the rescaled diffusion components to build the pseudotime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">palantir</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first compute diffusion maps</span>
<span class="n">palantir</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">run_diffusion_maps</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize the eigenvalues:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;DM_EigenValues&#39;</span><span class="p">])),</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;DM_EigenValues&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;EigenValues&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/90fa049c052667c291669e4011322722d14a71ebbaa84685f19714073adc556d.png" src="_images/90fa049c052667c291669e4011322722d14a71ebbaa84685f19714073adc556d.png" />
</div>
</div>
<p>Like before we see a gap between 8th and 9th eigenvalues. Now, palantir will use this result to rescale the top N eigenvectors, which are chosen automatically (but can also be userdefined) based on the gap between eigenvalues as shown above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palantir</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">determine_multiscale_space</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors_multiscaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5780, 7)
</pre></div>
</div>
</div>
</div>
<p>As we suspected, palantir considered the first 8 eigenvectors (and it removes the 0th eigenvector) as the most meaningful and rescaled them based on their eigenvalues (for more details, please see the manuscript).</p>
<p>Color tSNE by top 8 diffusion maps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the first 8 eigenvectors</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">c</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diff Map - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    
<span class="c1"># To save: </span>
<span class="c1"># fig.savefig(output_directory + &#39;umap_colored_by_diff_maps.png&#39;, bbox_inches = &#39;tight&#39;, dpi = 150)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1aeae91f8421b98f4333bae52d463315dee39cfb08d3e5ac04686399e2bf5b4d.png" src="_images/1aeae91f8421b98f4333bae52d463315dee39cfb08d3e5ac04686399e2bf5b4d.png" />
</div>
</div>
<p>Visualize genes for interpretation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize some gene expression on the above tsne:</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
           <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD34&#39;</span><span class="p">,</span> <span class="s1">&#39;MPO&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">,</span> <span class="s1">&#39;IRF8&#39;</span><span class="p">,</span> <span class="s1">&#39;ITGA2B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD79A&#39;</span><span class="p">],</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/92bc5f7a1d43176648fe8e05be172d2efd1d6be3d8542edff92d37220e771970.png" src="_images/92bc5f7a1d43176648fe8e05be172d2efd1d6be3d8542edff92d37220e771970.png" />
</div>
</div>
<section id="define-start-cell">
<h3>Define start cell<a class="headerlink" href="#define-start-cell" title="Link to this heading">#</a></h3>
<p>Palantir expects thatyou provide an example cell as a start point. The algorithm will use this cells as the initiating point of the trajectory but with each iteration, the start cell will be refined automatically. In other words, palantir is very robust to the choice of start cell, so it is OK that you only provide an approximate <code class="docutils literal notranslate"><span class="pre">start_cell</span></code>.</p>
<p>But how does one generally assign a start cell? This is a context dependent problem. In this data, the authors decided to find the cell with high expression of CD34 gene (the most primitive cell from Cluster 0) and define it as the start point. For this they selected a random cell from the highlighted region below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a start point</span>
<span class="c1"># Please note that the start_cell should be the barcode of the cell estimated to be an ideal start point</span>
<span class="n">start_cell</span> <span class="o">=</span> <span class="s1">&#39;Run5_164698952452459&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">select_cells</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cells</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cluster to select start cell&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">select_cells</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">start_cell</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cells</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Selected start cell&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f3f8ff2f5d6cb3df43a05962868d3b7e2f6faec18acad4d2950dbac7ea63196b.png" src="_images/f3f8ff2f5d6cb3df43a05962868d3b7e2f6faec18acad4d2950dbac7ea63196b.png" />
</div>
</div>
</section>
<section id="define-terminal-states">
<h3>Define terminal states<a class="headerlink" href="#define-terminal-states" title="Link to this heading">#</a></h3>
<p>Palantir can automatically identify the terminal points, so you can begin your analysis by seeing what palantir identifies as terminal state(s). However, if you want to use biological intuition to identify possible terminal states, you can specify the cells which you think are likely terminal states.</p>
<p>If you want a data driven way to identify potential terminal states then you can study the cells with the minimum and maximum values of the diffusion components. Since Palantir builds on the diffusion components, you can study the components itself to identify potential end states. Now, we will color the tSNE by diffusion components, and highlight the cells with min and max values for each component.</p>
<p>Note: we only look at the first 8 diffusion component because the gap in eigenvalues is highest there, meaning that palantir will focus on these 8 components to derive a pseudotime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors_multiscaled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5780, 7)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the first 8 eigenvectors (Note: we ignore the 0th so 7 really)</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">c</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    
    <span class="p">[</span><span class="n">id_min</span><span class="p">,</span> <span class="n">id_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">])[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][</span><span class="n">id_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
               <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][</span><span class="n">id_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][</span><span class="n">id_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
               <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">][</span><span class="n">id_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diff Map - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
    
<span class="c1"># To save: </span>
<span class="c1"># fig.savefig(output_directory + &#39;umap_colored_by_diff_maps.png&#39;, bbox_inches = &#39;tight&#39;, dpi = 150)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/083ec6fb89fa7156b8f10e1e4eee3be0f26550b5dcee02855ba28df8cab4b16f.png" src="_images/083ec6fb89fa7156b8f10e1e4eee3be0f26550b5dcee02855ba28df8cab4b16f.png" />
</div>
</div>
<p>In the plot above the tsne representation of the data is colored by each diffusion component. The cells with minimum value for the diffusion component is highlighted in red, while the cells with the maximum value for the diffusion component is highlighted is black. For the plots above, we can speculate that the potential terminal states are as follows after taking care of duplicates:</p>
<ol class="arabic simple">
<li><p>min and max of diffusion component 1</p></li>
<li><p>max of diffusion component 2</p></li>
<li><p>max of diffusion component 3</p></li>
<li><p>max of diffusion component 5</p></li>
<li><p>max of diffusion component 6</p></li>
</ol>
<p>We are making this claim, also based on the gene expression and cell types in each of these terminal states. So, when you adapt this code for your own data, we suggest that you study your data based on gene expression and as above where we looked at the cells with minimum and maximum values for each diffusion component.</p>
<p>Let’s get the cell barcode for the cells corresponding to the minimum and maximum values of the above mentioned diffusion components.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">terminal_states</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># for component 1</span>
<span class="n">cell_comp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">terminal_states</span> <span class="o">=</span> <span class="n">terminal_states</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">cell_comp1</span><span class="p">])</span>

<span class="c1"># for component 2</span>
<span class="n">cell_comp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">cell_comp2</span><span class="p">])</span>


<span class="c1"># for component 3</span>
<span class="n">cell_comp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">cell_comp3</span><span class="p">])</span>

<span class="c1"># for component 5</span>
<span class="n">cell_comp5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">5</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">cell_comp5</span><span class="p">])</span>

<span class="c1"># for component 6</span>
<span class="n">cell_comp6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;DM_EigenVectors&#39;</span><span class="p">][:,</span> <span class="mi">6</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">cell_comp6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">terminal_states</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Run4_239448276221238&#39;,
 &#39;Run4_236650105264556&#39;,
 &#39;Run5_239477254471070&#39;,
 &#39;Run4_130736318737710&#39;,
 &#39;Run5_191691434420467&#39;,
 &#39;Run4_200967489997038&#39;]
</pre></div>
</div>
</div>
</div>
<p>Visualize start and terminal states on tsne:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_cell_start</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">start_cell</span><span class="p">)</span>
<span class="n">select_cell_terminal</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">terminal_states</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cell_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cell_start</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cell_terminal</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">select_cell_terminal</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;terminal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Selected start cell and terminal states&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f3fd6a42220&gt;
</pre></div>
</div>
<img alt="_images/3f78b0742c64e8048de387a0c82d45e4d44279eb152385221e2738ab501cfd77.png" src="_images/3f78b0742c64e8048de387a0c82d45e4d44279eb152385221e2738ab501cfd77.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize some gene expression on the above tsne:</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
           <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD34&#39;</span><span class="p">,</span> <span class="s1">&#39;MPO&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">,</span> <span class="s1">&#39;IRF8&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/222b621beb4757907a67374af166ac328aac0de57dc6e0b4aae2cb4ae6af389f.png" src="_images/222b621beb4757907a67374af166ac328aac0de57dc6e0b4aae2cb4ae6af389f.png" />
</div>
</div>
</section>
<section id="compute-pseudotime">
<h3>Compute pseudotime<a class="headerlink" href="#compute-pseudotime" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pr_res</span> <span class="o">=</span> <span class="n">palantir</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">run_palantir</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
                                    <span class="n">early_cell</span> <span class="o">=</span> <span class="n">start_cell</span><span class="p">,</span> 
                                    <span class="n">terminal_states</span><span class="o">=</span><span class="n">terminal_states</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling and flocking waypoints...
Time for determining waypoints: 0.011640826861063639 minutes
Determining pseudotime...
Shortest path distances using 30-nearest neighbor graph...
Time for shortest paths: 0.3310884952545166 minutes
Iteratively refining the pseudotime...
Correlation at iteration 1: 0.9996
Correlation at iteration 2: 1.0000
Entropy and branch probabilities...
Markov chain construction...
Computing fundamental matrix and absorption probabilities...
Project results to all cells...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_entropy&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;, &#39;palantir_waypoints&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;, &#39;palantir_fate_probabilities&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<p>Now to further process pr_res, we will follow: <a class="reference external" href="https://nbviewer.org/github/dpeerlab/Palantir/blob/master/notebooks/Palantir_sample_notebook.ipynb">https://nbviewer.org/github/dpeerlab/Palantir/blob/master/notebooks/Palantir_sample_notebook.ipynb</a></p>
<p>Palantir generates the following results</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">palantir_pseudotime</span></code>: Pseudo time ordering of each cell</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">palantir_fate_probabilities</span></code>: Matrix of cells X terminal states. Each entry represents the probability of the corresponding cell reaching the respective terminal state</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">palantir_entropy</span></code>: A quantiative measure of the differentiation potential of each cell computed as the entropy of the multinomial terminal state probabilities</p></li>
</ul>
</section>
<section id="get-the-pseudotime">
<h3>Get the pseudotime<a class="headerlink" href="#get-the-pseudotime" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;palantir_pseudotime&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>index
Run4_120703408880541    0.543378
Run4_120703409056541    0.073480
Run4_120703409580963    0.745047
Run4_120703423990708    0.707525
Run4_120703424252854    0.495364
                          ...   
Run5_241114589051630    0.841101
Run5_241114589051819    0.400520
Run5_241114589128940    0.483058
Run5_241114589357942    0.872141
Run5_241114589841822    0.473073
Name: palantir_pseudotime, Length: 5780, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>In the output above, each row is a cell barcode and the number associated with each cell is it’s pseudotime alignment score (between 0 representing early and 1 representing differentiated).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the branch probabilities</span>
<span class="c1"># As shown below, palantir used the 6 terminally differentiated states</span>
<span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Run4_130736318737710</th>
      <th>Run4_200967489997038</th>
      <th>Run4_236650105264556</th>
      <th>Run4_239448276221238</th>
      <th>Run5_191691434420467</th>
      <th>Run5_239477254471070</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Run4_120703408880541</th>
      <td>0.194640</td>
      <td>0.042404</td>
      <td>0.589250</td>
      <td>0.000000</td>
      <td>0.071628</td>
      <td>0.096334</td>
    </tr>
    <tr>
      <th>Run4_120703409056541</th>
      <td>0.346379</td>
      <td>0.075168</td>
      <td>0.332505</td>
      <td>0.019021</td>
      <td>0.056162</td>
      <td>0.170764</td>
    </tr>
    <tr>
      <th>Run4_120703409580963</th>
      <td>0.914851</td>
      <td>0.014348</td>
      <td>0.031800</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.032569</td>
    </tr>
    <tr>
      <th>Run4_120703423990708</th>
      <td>0.874916</td>
      <td>0.021077</td>
      <td>0.046715</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.047844</td>
    </tr>
    <tr>
      <th>Run4_120703424252854</th>
      <td>0.354335</td>
      <td>0.122651</td>
      <td>0.203145</td>
      <td>0.000000</td>
      <td>0.034556</td>
      <td>0.278791</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Run5_241114589051630</th>
      <td>0.041180</td>
      <td>0.000000</td>
      <td>0.912767</td>
      <td>0.000000</td>
      <td>0.015487</td>
      <td>0.020382</td>
    </tr>
    <tr>
      <th>Run5_241114589051819</th>
      <td>0.384889</td>
      <td>0.083465</td>
      <td>0.284330</td>
      <td>0.000000</td>
      <td>0.048319</td>
      <td>0.189614</td>
    </tr>
    <tr>
      <th>Run5_241114589128940</th>
      <td>0.365257</td>
      <td>0.079772</td>
      <td>0.311678</td>
      <td>0.000000</td>
      <td>0.053226</td>
      <td>0.181225</td>
    </tr>
    <tr>
      <th>Run5_241114589357942</th>
      <td>0.025483</td>
      <td>0.000000</td>
      <td>0.946017</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.012613</td>
    </tr>
    <tr>
      <th>Run5_241114589841822</th>
      <td>0.388665</td>
      <td>0.084475</td>
      <td>0.278553</td>
      <td>0.000000</td>
      <td>0.047368</td>
      <td>0.191909</td>
    </tr>
  </tbody>
</table>
<p>5780 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can rename the different branches:</span>
<span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Branch1&#39;</span><span class="p">,</span> <span class="s1">&#39;Branch2&#39;</span><span class="p">,</span> <span class="s1">&#39;Branch3&#39;</span><span class="p">,</span> <span class="s1">&#39;Branch4&#39;</span><span class="p">,</span> <span class="s1">&#39;Branch5&#39;</span><span class="p">,</span> <span class="s1">&#39;Branch6&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the entropy</span>
<span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;palantir_entropy&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>index
Run4_120703408880541    1.208108
Run4_120703409056541    1.466803
Run4_120703409580963    0.398771
Run4_120703423990708    0.535005
Run4_120703424252854    1.453987
                          ...   
Run5_241114589051630    0.409000
Run5_241114589051819    1.437839
Run5_241114589128940    1.440396
Run5_241114589357942    0.279952
Run5_241114589841822    1.435856
Name: palantir_entropy, Length: 5780, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-the-pseudotime">
<h3>Visualize the pseudotime<a class="headerlink" href="#visualize-the-pseudotime" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;palantir_entropy&#39;</span><span class="p">,</span> <span class="s1">&#39;palantir_pseudotime&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a734d77da9e2608098b2ebcf3ec8c1f63fd389165023640c6546efa0dd4efb43.png" src="_images/a734d77da9e2608098b2ebcf3ec8c1f63fd389165023640c6546efa0dd4efb43.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize branch probability</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pr_res</span><span class="o">.</span><span class="n">branch_probs</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> 
              <span class="n">c</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Branch probability - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dfa42fd68521fd203b5431d8c82e0658bf869aab8877f18d21c0355d0aeb51f7.png" src="_images/dfa42fd68521fd203b5431d8c82e0658bf869aab8877f18d21c0355d0aeb51f7.png" />
</div>
</div>
</section>
<section id="visualize-the-probability-for-cells-to-reach-certain-terminal-state">
<h3>Visualize the probability for cells to reach certain terminal state<a class="headerlink" href="#visualize-the-probability-for-cells-to-reach-certain-terminal-state" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_cells</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Run5_164698952452459&quot;</span><span class="p">,</span> <span class="s2">&quot;Run5_170327461775790&quot;</span><span class="p">,</span> <span class="s2">&quot;Run4_121896095574750&quot;</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cell_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">example_cells</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
          <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">example_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
          <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">example_cells</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_tsne&#39;</span><span class="p">][</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
          <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">example_cells</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
       <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Branches&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
       <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Branches&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
       <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;palantir_fate_probabilities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Branches&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">example_cells</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Run4_121896095574750&#39;)
</pre></div>
</div>
<img alt="_images/afb5913d3f2c1fde1353f5b36a3436d83ea229cbb5c111563552495dd392375c.png" src="_images/afb5913d3f2c1fde1353f5b36a3436d83ea229cbb5c111563552495dd392375c.png" />
</div>
</div>
</section>
<section id="visualize-gene-expression-trends">
<h3>Visualize gene expression trends<a class="headerlink" href="#visualize-gene-expression-trends" title="Link to this heading">#</a></h3>
<p>Palantir allows us to study the gene expression trends along each of the branches or the pseudotime. This can help us identify regions along the pseudotime when gene expression change substantially, which can be informative about the biology of the system.</p>
<p>First, you can choose a branch to highlight:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">masks</span> <span class="o">=</span> <span class="n">palantir</span><span class="o">.</span><span class="n">presults</span><span class="o">.</span><span class="n">select_branch_cells</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_entropy&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;, &#39;palantir_waypoints&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;, &#39;palantir_fate_probabilities&#39;, &#39;branch_masks&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;branch_masks&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Branch1</th>
      <th>Branch2</th>
      <th>Branch3</th>
      <th>Branch4</th>
      <th>Branch5</th>
      <th>Branch6</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Run4_120703408880541</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run4_120703409056541</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Run4_120703409580963</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run4_120703423990708</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run4_120703424252854</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Run5_241114589051630</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run5_241114589051819</th>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Run5_241114589128940</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run5_241114589357942</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Run5_241114589841822</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>5780 rows × 6 columns</p>
</div></div></div>
</div>
<p>Visualizing the branch selection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">palantir</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_branch_selection</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on function plot_branch_selection in module palantir.plot:

plot_branch_selection(ad: anndata._core.anndata.AnnData, pseudo_time_key: str = &#39;palantir_pseudotime&#39;, fate_prob_key: str = &#39;palantir_fate_probabilities&#39;, masks_key: str = &#39;branch_masks&#39;, fates: Union[List[str], str, NoneType] = None, embedding_basis: str = &#39;X_umap&#39;, figsize: Tuple[float, float] = (15, 5), **kwargs)
    Plot cells along specific fates of pseudotime ordering and the UMAP embedding.
    
    Parameters
    ----------
    ad : sc.AnnData
        Annotated data matrix. The pseudotime and fate probabilities should be stored under the keys provided.
    pseudo_time_key : str, optional
        Key to access the pseudotime from obs of the AnnData object. Default is &#39;palantir_pseudotime&#39;.
    fate_prob_key : str, optional
        Key to access the fate probabilities from obsm of the AnnData object.
        Default is &#39;palantir_fate_probabilities&#39;.
    masks_key : str, optional
        Key to access the branch cell selection masks from obsm of the AnnData object.
        Default is &#39;branch_masks&#39;.
    fates : Union[List[str], str]
        The fates to be plotted. If not specified, all fates will be plotted.
    embedding_basis : str, optional
        Key to access the UMAP embedding from obsm of the AnnData object. Default is &#39;X_umap&#39;.
    figsize : Tuple[float, float], optional
        Width and height of each subplot in inches. The total height of the figure is determined by
        multiplying the height by the number of fates. Default is (15, 5).
    **kwargs
        Additional arguments passed to `matplotlib.pyplot.scatter`.
    
    Returns
    -------
    matplotlib.pyplot.Figure
        A matplotlib Figure object representing the plot of the branch selections.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palantir</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_branch_selection</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">embedding_basis</span> <span class="o">=</span> <span class="s1">&#39;tsne&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/12b41905ce7728b81ca8401e32a9269bb0cbe3adbaecb193c56f04392d190a72.png" src="_images/12b41905ce7728b81ca8401e32a9269bb0cbe3adbaecb193c56f04392d190a72.png" />
</div>
</div>
<p>Now we can compute the gene expression trend along the trajectory. It is recommended that you MAGIC impute the data for this otherwise the trends will not be informative (due to 0s).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/data/peer/sharmar1/msk_workshop/workshop_2024_spring/python_funs/&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">workshop_extra</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_entropy&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;, &#39;palantir_waypoints&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;, &#39;palantir_fate_probabilities&#39;, &#39;branch_masks&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workshop_extra</span><span class="o">.</span><span class="n">run_MAGIC</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
                         <span class="n">t</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                         <span class="n">use_rep</span><span class="o">=</span> <span class="s1">&#39;X_pca&#39;</span><span class="p">,</span> 
                         <span class="n">n_components</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                         <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> 
                         <span class="n">key_added</span> <span class="o">=</span> <span class="s1">&#39;magic&#39;</span><span class="p">,</span> 
                         <span class="n">impute</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing nearest neighbor graph
Using knn_affinity = 10
Creating Kernel
Creating Markov Matrix
Imputing
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_entropy&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;, &#39;palantir_waypoints&#39;, &#39;magic_diffmap_results&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;, &#39;palantir_fate_probabilities&#39;, &#39;branch_masks&#39;
    varm: &#39;PCs&#39;
    layers: &#39;magic_imputed_data&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene_trends</span> <span class="o">=</span> <span class="n">palantir</span><span class="o">.</span><span class="n">presults</span><span class="o">.</span><span class="n">compute_gene_trends</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">expression_key</span><span class="o">=</span><span class="s2">&quot;magic_imputed_data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Branch1
[2024-02-28 17:36:06,916] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (1,496) and rank = 1.0.
[2024-02-28 17:36:06,917] [INFO    ] Using covariance function Matern52(ls=1.0).
Branch2
[2024-02-28 17:36:12,296] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (1,327) and rank = 1.0.
[2024-02-28 17:36:12,297] [INFO    ] Using covariance function Matern52(ls=1.0).
Branch3
[2024-02-28 17:36:16,326] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (1,321) and rank = 1.0.
[2024-02-28 17:36:16,327] [INFO    ] Using covariance function Matern52(ls=1.0).
Branch4
[2024-02-28 17:36:20,407] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (539) and rank = 1.0.
[2024-02-28 17:36:20,407] [INFO    ] Using covariance function Matern52(ls=1.0).
Branch5
[2024-02-28 17:36:23,294] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (564) and rank = 1.0.
[2024-02-28 17:36:23,295] [INFO    ] Using covariance function Matern52(ls=1.0).
Branch6
[2024-02-28 17:36:26,265] [INFO    ] Using sparse Gaussian Process since n_landmarks (500) &lt; n_samples (1,334) and rank = 1.0.
[2024-02-28 17:36:26,266] [INFO    ] Using covariance function Matern52(ls=1.0).
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;, &#39;palantir_pseudotime&#39;, &#39;palantir_entropy&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;DM_EigenValues&#39;, &#39;palantir_waypoints&#39;, &#39;magic_diffmap_results&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;DM_EigenVectors&#39;, &#39;DM_EigenVectors_multiscaled&#39;, &#39;palantir_fate_probabilities&#39;, &#39;branch_masks&#39;
    varm: &#39;PCs&#39;, &#39;gene_trends_Branch1&#39;, &#39;gene_trends_Branch2&#39;, &#39;gene_trends_Branch3&#39;, &#39;gene_trends_Branch4&#39;, &#39;gene_trends_Branch5&#39;, &#39;gene_trends_Branch6&#39;
    layers: &#39;magic_imputed_data&#39;
    obsp: &#39;DM_Kernel&#39;, &#39;DM_Similarity&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CD34&quot;</span><span class="p">,</span> <span class="s2">&quot;MPO&quot;</span><span class="p">,</span> <span class="s2">&quot;GATA1&quot;</span><span class="p">,</span> <span class="s2">&quot;IRF8&quot;</span><span class="p">]</span>
<span class="n">palantir</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_gene_trends</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">genes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/be9e7eb3aac4e7efb0ee2229a9fc71bdaf79e6dc3c8f3cf0af635e0cb18c4f9f.png" src="_images/be9e7eb3aac4e7efb0ee2229a9fc71bdaf79e6dc3c8f3cf0af635e0cb18c4f9f.png" />
</div>
</div>
<p>As heatmaps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palantir</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_gene_trend_heatmaps</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">genes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e95898b6861c0b940251f174b9228f7d7268f43a8ee4429068993416fdb6e29a.png" src="_images/e95898b6861c0b940251f174b9228f7d7268f43a8ee4429068993416fdb6e29a.png" />
</div>
</div>
</section>
<section id="clustering-gene-expression-trends">
<h3>Clustering gene expression trends<a class="headerlink" href="#clustering-gene-expression-trends" title="Link to this heading">#</a></h3>
<p>It may also be informative to group genes together based on how they trend along the pseudotime. For exposition, we will randomly sample 1000 genes from the data and cluster them based on how they trend along Branch1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">sample_genes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">var_names</span><span class="p">),</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">palantir</span><span class="o">.</span><span class="n">presults</span><span class="o">.</span><span class="n">cluster_gene_trends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on function cluster_gene_trends in module palantir.presults:

cluster_gene_trends(data: Union[anndata._core.anndata.AnnData, pandas.core.frame.DataFrame], branch_name: str, genes: Union[List[str], NoneType] = None, gene_trend_key: Union[str, NoneType] = &#39;gene_trends&#39;, n_neighbors: int = 150, **kwargs) -&gt; pandas.core.series.Series
    Cluster gene trends using the Leiden algorithm.
    
    This function applies the Leiden clustering algorithm to gene expression trends
    along the pseudotemporal trajectory. If the input is an AnnData object, it uses
    the gene trends stored in the `varm` attribute accessed using the `gene_trend_key`.
    If the input is a DataFrame, it directly uses the input data for clustering.
    
    Parameters
    ----------
    data : Union[sc.AnnData, pd.DataFrame]
        AnnData object or a DataFrame of gene expression trends.
    branch_name : str
        Name of the branch for which the gene trends are to be clustered.
    genes : list of str, optional
        List of genes to be considered for clustering. If None, all genes are considered. Default is None.
    gene_trend_key : str, optional
        Key to access gene trends in the AnnData object&#39;s varm. Default is &#39;palantir_gene_trends&#39;.
    n_neighbors : int, optional
        The number of nearest neighbors to use for the k-NN graph construction. Default is 150.
    **kwargs
        Additional keyword arguments passed to `scanpy.tl.leiden`.
    
    Returns
    -------
    pd.Series
        A pandas series with the cluser lables for all passed genes.
    
    Raises
    ------
    KeyError
        If `gene_trend_key` is None when `data` is an AnnData object.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">communities</span> <span class="o">=</span> <span class="n">palantir</span><span class="o">.</span><span class="n">presults</span><span class="o">.</span><span class="n">cluster_gene_trends</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> 
                                                    <span class="n">branch_name</span> <span class="o">=</span> <span class="s2">&quot;Branch1&quot;</span><span class="p">,</span> 
                                                    <span class="n">genes</span> <span class="o">=</span> <span class="n">sample_genes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palantir</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_gene_trend_clusters</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="s2">&quot;Branch1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/36ceaea67690cdff3ea09e608bba60ea9f1b02632108ab63ca16bd94e84621da.png" src="_images/36ceaea67690cdff3ea09e608bba60ea9f1b02632108ab63ca16bd94e84621da.png" />
</div>
</div>
</section>
</section>
<section id="paga">
<h2>PAGA<a class="headerlink" href="#paga" title="Link to this heading">#</a></h2>
<p>PAGA (PArtition-based Graph Abstraction) is another method that can be used to study connectivities in single-cell data. Often, studying cell differentiation process using pseudotime may not be optimal due to issues resulting from inadequate sampling of cells. In such cases, the notion of connecting clusters of cells using graph-based metrics (to avoid errors that Euclidean distance might cause) has been proposed as an alternative, and PAGA is one such method. PAGA attempts to preserve both continuous and disconnected structure in the data.</p>
<p>Ref: <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6425583/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6425583/</a></p>
<p>PAGA relies on both clustering and nearest neighbor graphs (which can be constructed on PCA or on diffusion components). We will provide code to do both.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;clusters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/sharmar1/miniconda3/envs/workshop_2024/lib/python3.8/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div>
</div>
<img alt="_images/2cbd42d3fb1915d43b1d789f717ba80bc9d6a1680180c711f882fa2821162d6c.png" src="_images/2cbd42d3fb1915d43b1d789f717ba80bc9d6a1680180c711f882fa2821162d6c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We are computing 300 principal components as that is what the authors used. </span>
<span class="c1"># The rationale was that they wanted to consider enough PCs to explain 75% of the variance in the data</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_comps</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute nearest neighbors </span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="s1">&#39;X_pca&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="paga-with-distances-computed-on-pca">
<h3>PAGA with distances computed on PCA<a class="headerlink" href="#paga-with-distances-computed-on-pca" title="Link to this heading">#</a></h3>
<p>Since we have already computed k-nearest neighbor distance graph on the PCA, we can simply invoke that result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">paga</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;paga&#39;, &#39;clusters_sizes&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;paga&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;connectivities&#39;: &lt;10x10 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
 	with 74 stored elements in Compressed Sparse Row format&gt;,
 &#39;connectivities_tree&#39;: &lt;10x10 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
 	with 9 stored elements in Compressed Sparse Row format&gt;,
 &#39;groups&#39;: &#39;clusters&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">paga</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">],</span> <span class="n">node_size_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1449f2c05b547cd4f44669567d05d89595789372d4918407adeb6270b1257c4b.png" src="_images/1449f2c05b547cd4f44669567d05d89595789372d4918407adeb6270b1257c4b.png" />
</div>
</div>
<p>Interpreting the plot above:</p>
<ol class="arabic simple">
<li><p>Each circle indicates a cluster and the size of the circle is proportional to size of the cluster.</p></li>
<li><p>Two circles that are phenotypically close to each other - as quantified by the distances computed on the PCA space - are connected to each other.</p></li>
<li><p>The width of the connecting edges is proportional to the similarity between the clusters.</p></li>
</ol>
<p>We can also highlight the expression of select genes onto the PAGA plot as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">paga</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD34&#39;</span><span class="p">,</span> <span class="s1">&#39;MPO&#39;</span><span class="p">,</span> <span class="s1">&#39;GATA1&#39;</span><span class="p">],</span> <span class="n">node_size_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e863bd4e12aff3e17405f0f1dcdb6e944966e9ed5014c652c821f2bde3e2f2b9.png" src="_images/e863bd4e12aff3e17405f0f1dcdb6e944966e9ed5014c652c821f2bde3e2f2b9.png" />
</div>
</div>
</section>
<section id="paga-on-diffusion-components">
<h3>PAGA on diffusion components<a class="headerlink" href="#paga-on-diffusion-components" title="Link to this heading">#</a></h3>
<p>As we discussed above, PAGA can also compute connectivites between clusters based on distances in the diffusion space. For the example, below we will consider distances in the diffusion space defined by the first seven eigenvectors (ignoring the 0th eigenvector – automatically ignored by PAGA).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;paga&#39;, &#39;clusters_sizes&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">diffmap</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;neighbors_30&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])),</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;EigenValue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4cbf4c8e9d4c8b6775bf1ad563f49b812e05f06697586ff71c7484c5b26591da.png" src="_images/4cbf4c8e9d4c8b6775bf1ad563f49b812e05f06697586ff71c7484c5b26591da.png" />
</div>
</div>
<p>Based on the above plot, we will consider only the top 7 components:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_diffmap&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;diffmap_evals&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5780, 7)
</pre></div>
</div>
</div>
</div>
<p>Compute neighbors in diffusion components space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">,</span> <span class="n">key_added</span> <span class="o">=</span> <span class="s1">&#39;diff_neighbors&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Re-do PAGA on diffusion map space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">paga</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;clusters&#39;</span><span class="p">,</span> <span class="n">neighbors_key</span> <span class="o">=</span> <span class="s1">&#39;diff_neighbors&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;paga&#39;, &#39;clusters_sizes&#39;, &#39;diffmap_evals&#39;, &#39;diff_neighbors&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;X_diffmap&#39;, &#39;diffmap_evecs&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;, &#39;diff_neighbors_distances&#39;, &#39;diff_neighbors_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">paga</span><span class="p">(</span><span class="n">adata_bm</span><span class="p">,</span> <span class="n">node_size_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8907f09cff3a56e28d9f7488f0e1b3ae1fff0a4d599331a186dd15e45060ff2b.png" src="_images/8907f09cff3a56e28d9f7488f0e1b3ae1fff0a4d599331a186dd15e45060ff2b.png" />
</div>
</div>
<p>As you can see the two results of PAGA look visually quite similar (except that cluster 9 was more connected to other clusters when computing distances in the PCA space vs when computing in the diffusion space). It will be up to you to evaluate such cases using what is known about the cell types. In this case, Cluster 9 is ITGA2B+ (Megakaryocytes) and it is more phenotypically closer to cluster 2 and 8 as opposed to clusters 1 and 4. Therefore, diffusion distance based PAGA would be more faithful representation of the data here.</p>
</section>
</section>
<section id="using-results-to-quantify-distance-between-clusters">
<h2>Using results to quantify distance between clusters<a class="headerlink" href="#using-results-to-quantify-distance-between-clusters" title="Link to this heading">#</a></h2>
<p>You can extract the similarity between clusters using diffusion maps space as follows. We see 0 when two clusters are not connected to each other in PAGA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;paga&#39;</span><span class="p">][</span><span class="s1">&#39;connectivities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
             <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cluster-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">])],</span> 
             <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cluster-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">])])</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Cluster-0</th>
      <th>Cluster-1</th>
      <th>Cluster-2</th>
      <th>Cluster-3</th>
      <th>Cluster-4</th>
      <th>Cluster-5</th>
      <th>Cluster-6</th>
      <th>Cluster-7</th>
      <th>Cluster-8</th>
      <th>Cluster-9</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Cluster-0</th>
      <td>0.000000</td>
      <td>0.336017</td>
      <td>0.042759</td>
      <td>0.008247</td>
      <td>0.004282</td>
      <td>0.008583</td>
      <td>0.000415</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.001461</td>
    </tr>
    <tr>
      <th>Cluster-1</th>
      <td>0.336017</td>
      <td>0.000000</td>
      <td>0.014329</td>
      <td>0.139999</td>
      <td>0.569539</td>
      <td>0.011620</td>
      <td>0.204404</td>
      <td>0.126322</td>
      <td>0.000000</td>
      <td>0.001660</td>
    </tr>
    <tr>
      <th>Cluster-2</th>
      <td>0.042759</td>
      <td>0.014329</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.083272</td>
      <td>0.000000</td>
      <td>0.000626</td>
      <td>0.000000</td>
      <td>0.560948</td>
      <td>0.913564</td>
    </tr>
    <tr>
      <th>Cluster-3</th>
      <td>0.008247</td>
      <td>0.139999</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.191141</td>
      <td>0.006204</td>
      <td>0.937366</td>
      <td>0.005905</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Cluster-4</th>
      <td>0.004282</td>
      <td>0.569539</td>
      <td>0.083272</td>
      <td>0.191141</td>
      <td>0.000000</td>
      <td>0.001533</td>
      <td>0.675147</td>
      <td>0.178244</td>
      <td>0.000000</td>
      <td>0.007358</td>
    </tr>
    <tr>
      <th>Cluster-5</th>
      <td>0.008583</td>
      <td>0.011620</td>
      <td>0.000000</td>
      <td>0.006204</td>
      <td>0.001533</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Cluster-6</th>
      <td>0.000415</td>
      <td>0.204404</td>
      <td>0.000626</td>
      <td>0.937366</td>
      <td>0.675147</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.410856</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Cluster-7</th>
      <td>0.000000</td>
      <td>0.126322</td>
      <td>0.000000</td>
      <td>0.005905</td>
      <td>0.178244</td>
      <td>0.000000</td>
      <td>0.410856</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Cluster-8</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.560948</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Cluster-9</th>
      <td>0.001461</td>
      <td>0.001660</td>
      <td>0.913564</td>
      <td>0.000000</td>
      <td>0.007358</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note: We can always repurpose this code to define distance or similarity between any two groups of cells by just replacing <code class="docutils literal notranslate"><span class="pre">clusters</span></code> column in obs with whatever grouping of cells we want.</p>
<p>Alternatively, for data where cells are along a continuum, we can use the diffusion components to compute phenotypic distances between cells or clusters. As we discussed, Euclidean distance in the diffusion component space is a good approximation for phenotypic distance between cells. Of course, we need to be careful with only the meaningful diffusion components (e.g. in the above case we will use diffusion components 1-7).</p>
<p>In the following code, we will compute distance (A) between each pair of cells within cluster 0 (B) between cells in cluster 0 and cluster 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 5780 × 14612
    obs: &#39;clusters&#39;
    uns: &#39;cluster_colors&#39;, &#39;ct_colors&#39;, &#39;clusters_colors&#39;, &#39;pca&#39;, &#39;neighbors_30&#39;, &#39;paga&#39;, &#39;clusters_sizes&#39;, &#39;diffmap_evals&#39;, &#39;diff_neighbors&#39;
    obsm: &#39;tsne&#39;, &#39;X_tsne&#39;, &#39;X_pca&#39;, &#39;X_diffmap&#39;, &#39;diffmap_evecs&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;neighbors_30_distances&#39;, &#39;neighbors_30_connectivities&#39;, &#39;diff_neighbors_distances&#39;, &#39;diff_neighbors_connectivities&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5780, 7)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cells_C0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cells_C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_C0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells_C1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1118 984
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="n">distance_pairwise_C0</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">][</span><span class="n">cells_C0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">distance_pairwise_C0_C1</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">][</span><span class="n">cells_C0</span><span class="p">,</span> <span class="p">:],</span> 
                                             <span class="n">adata_bm</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;diffmap_evecs&#39;</span><span class="p">][</span><span class="n">cells_C1</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">distance_pairwise_C0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">distance_pairwise_C0_C1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1118, 1118) (1118, 984)
</pre></div>
</div>
</div>
</div>
<p>As we see, <code class="docutils literal notranslate"><span class="pre">distance_pairwise_C0</span></code> holds the pairwise distance between cells in cluster 0; <code class="docutils literal notranslate"><span class="pre">distance_pairwise_C0_C1</span></code> holds the pairwise distance between cells in cluster 0 and cluster 1.</p>
<p>We can visualize the distances as a boxplot for comparison. Also, note that <code class="docutils literal notranslate"><span class="pre">distance_pairwise_C0</span></code> is a symmetric matrix as distance from cell1 in cluster 0 to cell2 in cluster 0 is the same as distance from cell2 in cluster0 to cell1 in cluster 0. So we will only look at the upper traingle of the <code class="docutils literal notranslate"><span class="pre">distance_pairwise_C0</span></code> matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">within_C0</span> <span class="o">=</span> <span class="n">distance_pairwise_C0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">distance_pairwise_C0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">between_C0_C1</span> <span class="o">=</span> <span class="n">distance_pairwise_C0_C1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">within_C0</span><span class="p">,</span> <span class="n">between_C0_C1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Distance inside C0&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance between C0 and C1&#39;</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Distance in diffusion space&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Distance in diffusion space&#39;)
</pre></div>
</div>
<img alt="_images/67fdea94117f20088e0856f020bbe1c0365931941ecc7f8394588053a607bf1e.png" src="_images/67fdea94117f20088e0856f020bbe1c0365931941ecc7f8394588053a607bf1e.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction 3</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-processed-data">Load processed data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#trajectory-inference">Trajectory Inference</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diffusion-maps">Diffusion Maps</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-1-scanpy-inbuilt-diffusion-maps">Method 1: Scanpy inbuilt diffusion maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-data-2-cells-along-a-continuum">Example data 2: Cells along a continuum</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nearest-neighbor-and-diffusion-maps">Nearest neighbor and diffusion maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-2-using-code-for-magic-to-do-diffusion-maps">Method 2: Using code for MAGIC to do diffusion maps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#palantir">Palantir</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-start-cell">Define start cell</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-terminal-states">Define terminal states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-pseudotime">Compute pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-the-pseudotime">Get the pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-pseudotime">Visualize the pseudotime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-probability-for-cells-to-reach-certain-terminal-state">Visualize the probability for cells to reach certain terminal state</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-gene-expression-trends">Visualize gene expression trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-gene-expression-trends">Clustering gene expression trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#paga">PAGA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#paga-with-distances-computed-on-pca">PAGA with distances computed on PCA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#paga-on-diffusion-components">PAGA on diffusion components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-results-to-quantify-distance-between-clusters">Using results to quantify distance between clusters</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sara Jimenez
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>